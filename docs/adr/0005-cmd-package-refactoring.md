# 5. cmd パッケージのリファクタリング

Date: 2025-01-30

## Status

Accepted

## Context

cmd/root.goファイルには複数の責務が混在しており、テストカバレッジも不十分でした。具体的には：

- コマンドライン引数の処理
- SageMakerクライアントの初期化と設定検証
- リソース（Endpoints, Notebooks, Studio apps）の並行取得
- エラー処理とリトライロジック
- 結果の表示処理

これらの責務を適切に分離し、テスト可能性を向上させる必要がありました。

## Decision

段階的なリファクタリングアプローチを採用し、各ステップでテストを追加しながら進めることにしました。

Phase 1: テストカバレッジの向上
- cmd/root_test.goの作成
- 基本実行のテスト
- フラグ処理のテスト
- エラーケースのテスト

これにより、既存の機能を壊すことなくリファクタリングを進められる基盤を整備します。

Phase 2: 包括的なテストカバレッジの実装
各ステップで以下の方針を採用：
1. モック/スタブの作成
2. テストケースの実装
3. テストの実行と検証
4. カバレッジの確認
5. 必要に応じてリファクタリング

ステップ1: SageMakerクライアント関連のテスト
- クライアント初期化のテスト（正常系/異常系）
- ValidateConfiguration関数のテスト（リソースあり/なしのケース）

ステップ2: リソース取得処理のテスト
- 各リソースタイプ（Endpoints, Notebooks, Studio apps）の並行取得テスト
- 空のリソース一覧を返すケース
- リソースが存在する場合のケース
- リトライ可能なエラーが発生した場合のケース

ステップ3: 表示処理のテスト
- PrintHeader/PrintFooterの呼び出しタイミングの検証
- リソースが見つからない場合のPrintNoResourcesの呼び出し検証
- JSONフォーマット出力のテスト

ステップ4: エラーハンドリングのテスト
- 複数のエラーが発生した場合の最初のエラー返却の検証
- RetryableErrorの処理検証
- エラーメッセージのフォーマット検証

## Consequences

### Positive

- テストカバレッジが向上し、既存機能の動作保証が強化される
- 段階的なアプローチにより、リスクを最小限に抑えられる
- エラーケースの明確化により、より堅牢な実装が可能になる

### Negative

- 追加のテストコードのメンテナンスが必要
- テストの実行時間が増加

### Neutral

- テストファイルの追加により、プロジェクトサイズが増加
